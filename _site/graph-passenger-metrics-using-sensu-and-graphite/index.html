

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>Graph passenger metrics using sensu and graphite. - Linuxdynasty</title>







<meta property="og:locale" content="en">
<meta property="og:site_name" content="Linuxdynasty">
<meta property="og:title" content="Graph passenger metrics using sensu and graphite.">


  <link rel="canonical" href="http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/">
  <meta property="og:url" content="http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/">



  <meta property="og:description" content="Before I started working here, they were only collecting the common metricsfor passenger (queue, processes, and max processes). After being here a littleover a month, I realized that we were always logging into the nodesand running watch passenger-status, and watching how much memorycertain passenger workers were consuming and how much time each of theseprocesses were taking.">



  <meta name="twitter:site" content="@linuxdynasty">
  <meta name="twitter:title" content="Graph passenger metrics using sensu and graphite.">
  <meta name="twitter:description" content="Before I started working here, they were only collecting the common metricsfor passenger (queue, processes, and max processes). After being here a littleover a month, I realized that we were always logging into the nodesand running watch passenger-status, and watching how much memorycertain passenger workers were consuming and how much time each of theseprocesses were taking.">
  <meta name="twitter:url" content="http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2014-10-10T00:00:00-07:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Allen Sanabria",
      "url" : "http://10.0.0.146:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://10.0.0.146:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Linuxdynasty Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://10.0.0.146:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://10.0.0.146:4000/">Linuxdynasty</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://10.0.0.146:4000/">Home</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    





<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://10.0.0.146:4000/images/avatar.jpg" class="author__avatar" alt="Allen Sanabria">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Allen Sanabria</h3>
    <p class="author__bio">Systems admin who loves programming, monitoring, automation, and metrics.</p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Somewhere HOT</li>
      
      
      
        <li><a href="mailto:asanabria <@> linuxdynasty dot org"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
      
      
        <li><a href="https://keybase.io/linuxdynasty"><i class="fa fa-fw fa-key" aria-hidden="true"></i> Keybase</a></li>
      
      
        <li><a href="https://twitter.com/linuxdynasty"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
      
      
      
        <li><a href="https://plus.google.com/+AllenSanabria"><i class="fa fa-fw fa-google-plus-square" aria-hidden="true"></i> Google+</a></li>
      
      
        <li><a href="https://www.linkedin.com/in/linuxdynasty"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li>
      
      
      
      
      
        <li><a href="https://bitbucket.org/linuxdynasty"><i class="fa fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
      
      
        <li><a href="https://github.com/linuxdynasty"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
      
      
        <li><a href="https://www.stackoverflow.com/users/3511210/linuxdynasty"><i class="fa fa-fw fa-stack-overflow" aria-hidden="true"></i> Stackoverflow</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Graph passenger metrics using sensu and graphite.">
    <meta itemprop="description" content="Before I started working here, they were only collecting the common metricsfor passenger (queue, processes, and max processes). After being here a littleover a month, I realized that we were always logging into the nodesand running watch passenger-status, and watching how much memorycertain passenger workers were consuming and how much time each of theseprocesses were taking.">
    <meta itemprop="datePublished" content="October 10, 2014">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Graph passenger metrics using sensu and graphite.
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  1 minute read
	
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <p>Before I started working here, they were only collecting the common metrics
for passenger (queue, processes, and max processes). After being here a little
over a month, I realized that we were always logging into the nodes
and running watch passenger-status, and watching how much memory
certain passenger workers were consuming and how much time each of these
processes were taking.</p>

<p>I kept telling my team, there had to be a better way of gathering this information.
After a quick glance at passenge-status –help, I hit the gold mine.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Usage: passenger-status <span class="o">[</span>options] <span class="o">[</span>Phusion Passenger<span class="s1">'s PID]

Tool for inspecting Phusion Passenger'</span>s internal status.

Options:
        --show<span class="o">=</span>pool|requests|backtraces|xml|union_station
                                     Whether to show the pool<span class="s1">'s contents,
                                     the currently running requests,
                                     the backtraces of all threads or an XML
                                     description of the pool.
    -v, --verbose                    Show verbose information.</span></code></pre></figure>

<h3 id="download-script">Download Script</h3>

<ul>
  <li><a href="https://github.com/linuxdynasty/Linuxdynasty/blob/master/scripts/sensu/metrics/passenger_metrics.rb">Passenger Metrics</a></li>
</ul>

<h3 id="dependencies">Dependencies</h3>
<ul>
  <li><a href="http://sensuapp.org/">Sensu</a> (shipper)</li>
  <li><a href="http://graphite.wikidot.com/">Graphite</a></li>
  <li><a href="http://www.nokogiri.org/">NokoGiri</a></li>
</ul>

<h3 id="testing-passenger-status---show-xml">Testing passenger-status –show xml</h3>

<p>If you installed libxml2-utils, the xml will look very nice..
Lets take a quick glance, on what the show xml command will display….</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">passenger-status --show xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"iso8859-1"</span>?&gt;
&lt;info <span class="nv">version</span><span class="o">=</span><span class="s2">"2"</span>&gt;
   &lt;process_count&gt;1&lt;/process_count&gt;
   &lt;max&gt;20&lt;/max&gt;
   &lt;capacity_used&gt;1&lt;/capacity_used&gt;
   &lt;get_wait_list_size&gt;0&lt;/get_wait_list_size&gt;
   &lt;get_wait_list/&gt;
   &lt;supergroups&gt;
      &lt;supergroup&gt;
         &lt;name&gt;/home/deploy/test_app/current&lt;/name&gt;
         &lt;state&gt;READY&lt;/state&gt;
         &lt;get_wait_list_size&gt;0&lt;/get_wait_list_size&gt;
         &lt;capacity_used&gt;1&lt;/capacity_used&gt;</code></pre></figure>

<p>Another example of the xml data, but showing you the process data instead…</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">passenger-status --show xml
          &lt;processes&gt;
               &lt;process&gt;
                  &lt;pid&gt;8540&lt;/pid&gt;
                  &lt;sticky_session_id&gt;1653709171&lt;/sticky_session_id&gt;
                  &lt;gupid&gt;167557a-WVPmDSUsnlj&lt;/gupid&gt;
                  &lt;connect_password&gt;l;sdkflskdjfslkfjsaj;flkdjs&lt;/connect_password&gt;
                  &lt;concurrency&gt;1&lt;/concurrency&gt;
                  &lt;sessions&gt;0&lt;/sessions&gt;
                  &lt;busyness&gt;0&lt;/busyness&gt;
                  &lt;processed&gt;102&lt;/processed&gt;
                  &lt;spawner_creation_time&gt;1412922319025804&lt;/spawner_creation_time&gt;
                  &lt;spawn_start_time&gt;1412958391718240&lt;/spawn_start_time&gt;
                  &lt;spawn_end_time&gt;1412958391746191&lt;/spawn_end_time&gt;
                  &lt;last_used&gt;1412958455204460&lt;/last_used&gt;
                  &lt;uptime&gt;1m 5s&lt;/uptime&gt;
                  &lt;life_status&gt;ALIVE&lt;/life_status&gt;
                  &lt;enabled&gt;ENABLED&lt;/enabled&gt;
                  &lt;has_metrics&gt;true&lt;/has_metrics&gt;
                  &lt;cpu&gt;4&lt;/cpu&gt;
                  &lt;rss&gt;171028&lt;/rss&gt;
                  &lt;pss&gt;136789&lt;/pss&gt;
                  &lt;private_dirty&gt;103424&lt;/private_dirty&gt;
                  &lt;swap&gt;0&lt;/swap&gt;
                  &lt;real_memory&gt;103424&lt;/real_memory&gt;
                  &lt;vmsize&gt;642504&lt;/vmsize&gt;</code></pre></figure>

<h3 id="running-the-script">Running the script</h3>

<p>As you can see, you can get a wealth of data. Data that will allow you and your
team to easily track down what is happening in you rails/sinatra cluster.</p>

<p>This script was written to work with Sensu and it’s graphite handler.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/opt/sensu/embedded/bin/ruby /etc/sensu/plugins/passenger_metrics.rb --scheme rails-01.passenger
rails-01.passenger.max_pool_size  50  1412958773
rails-01.passenger.processes  23  1412958773
rails-01.passenger.top_level_queue    0   1412958773
rails-01.passenger._var_www_html_test_api_current.queue    0   1412958773
rails-01.passenger._var_www_html_test_api_current.processes    23  1412958773
rails-01.passenger._var_www_html_test_api_current.processes_being_spawned  0   1412958773
rails-01.passenger._var_www_html_test_api_current.process_1.processed  3567    1412958773
rails-01.passenger._var_www_html_test_api_current.process_1.pid    7703    1412958773
rails-01.passenger._var_www_html_test_api_current.process_1.uptime 921 1412958773
rails-01.passenger._var_www_html_test_api_current.process_1.memory 909664  1412958773
rails-01.passenger._var_www_html_test_api_current.process_1.cpu_percent    27  1412958773
rails-01.passenger._var_www_html_test_api_current.process_2.processed  2194    1412958773
rails-01.passenger._var_www_html_test_api_current.process_2.pid    11878   1412958773
rails-01.passenger._var_www_html_test_api_current.process_2.uptime 659 1412958773
rails-01.passenger._var_www_html_test_api_current.process_2.memory 644108  1412958773
rails-01.passenger._var_www_html_test_api_current.process_2.cpu_percent    23  1412958773
rails-01.passenger._var_www_html_test_api_current.process_3.processed  1484    1412958773
rails-01.passenger._var_www_html_test_api_current.process_3.pid    16146   1412958773
rails-01.passenger._var_www_html_test_api_current.process_3.uptime 402 1412958773
rails-01.passenger._var_www_html_test_api_current.process_3.memory 691392  1412958773
rails-01.passenger._var_www_html_test_api_current.process_3.cpu_percent    32  1412958773
rails-01.passenger._var_www_html_test_api_current.process_4.processed  1343    1412958773
rails-01.passenger._var_www_html_test_api_current.process_4.pid    16738   1412958773
rails-01.passenger._var_www_html_test_api_current.process_4.uptime 353 1412958773
rails-01.passenger._var_www_html_test_api_current.process_4.memory 521676  1412958773
rails-01.passenger._var_www_html_test_api_current.process_4.cpu_percent    32  1412958773</code></pre></figure>

<p>###Screenshots</p>

<p>Now you can create dashboards, with enough information, that the developers
will no longer need to ask you what is happening with passenger.</p>

<figure class="">
    <a href="http://10.0.0.146:4000/assets/passenger_workers.png"><img src="http://10.0.0.146:4000/assets/passenger_workers.png" alt="" /></a>
    <figcaption>Passenger Workers.</figcaption>
</figure>

<figure class="">
    <a href="http://10.0.0.146:4000/assets/passenger_queues.png"><img src="http://10.0.0.146:4000/assets/passenger_queues.png" alt="" /></a>
    <figcaption>Passenger Queues.</figcaption>
</figure>

<figure class="">
    <a href="http://10.0.0.146:4000/assets/passenger_memory_used.png"><img src="http://10.0.0.146:4000/assets/passenger_memory_used.png" alt="" /></a>
    <figcaption>Passenger Workers Memory Used.</figcaption>
</figure>

<figure class="">
    <a href="http://10.0.0.146:4000/assets/passenger_time_spent.png"><img src="http://10.0.0.146:4000/assets/passenger_time_spent.png" alt="" /></a>
    <figcaption>Passenger Workers Time Spent.</figcaption>
</figure>

<figure class="">
    <a href="http://10.0.0.146:4000/assets/nginx_passenger.png"><img src="http://10.0.0.146:4000/assets/nginx_passenger.png" alt="" /></a>
    <figcaption>Nginx and Passenger Stats.</figcaption>
</figure>

        
      </section>

      <footer class="page__meta">
        
        




        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2014-10-10T00:00:00-07:00">October 10, 2014</time></p>
        
      </footer>

      

<section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://10.0.0.146:4000/graph-passenger-metrics-using-sensu-and-graphite/" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      


  <nav class="pagination">
    
      <a href="http://10.0.0.146:4000/migrated-from-wordpress-to-github-dot-io-pages/" class="pagination--pager" title="Migrated from wordpress to github.io pages
">Previous</a>
    
    
      <a href="http://10.0.0.146:4000/graph-resque-metrics-using-sensu-and-graphite/" class="pagination--pager" title="Graph resque metrics using sensu and graphite.
">Next</a>
    
  </nav>

    </div>

    
      

<div class="page__comments">
  <h4 class="page__comments-title">Leave a Comment</h4>
  
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
    <div class="page__related">
      
        <h4 class="page__related-title">You May Also Enjoy</h4>
      
      <div class="grid__wrapper">
        
          





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://10.0.0.146:4000/ansible-filters-and-how-they-can-make-your-playbooks-dynamic/" rel="permalink">How to use Ansible AWS filters to make your playbooks and roles dynamic.
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  3 minute read
	
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Before I get into how I leverage Filter plugins, 1st let me post a resource about what Filters are in Ansible and how you can leverage them. Common Filter in...</p>
  </article>
</div>
        
          





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://10.0.0.146:4000/graph-resque-metrics-using-sensu-and-graphite/" rel="permalink">Graph resque metrics using sensu and graphite.
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  1 minute read
	
</p>
    
    <p class="archive__item-excerpt" itemprop="description">We are using Resque for our background jobs and we use the Resque Web interface
to keep track of what is happening. But the only issue, is that we had no
rea...</p>
  </article>
</div>
        
          





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://10.0.0.146:4000/migrated-from-wordpress-to-github-dot-io-pages/" rel="permalink">Migrated from wordpress to github.io pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  less than 1 minute read
	
</p>
    
    <p class="archive__item-excerpt" itemprop="description">I just finished migrating from wordpress, and I love having the simplicity of 
just managing static pages and being able to edit them right from vim.
I will ...</p>
  </article>
</div>
        
          





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://10.0.0.146:4000/python/zenoss/redis/howto-check-redis-availability-stats-redis-py-zenoss-python/" rel="permalink">HowTo check redis availability and get stats using Redis-py, Zenoss, and Python
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  2 minute read
	
</p>
    
    <p class="archive__item-excerpt" itemprop="description">My team was assigned to create a redis slave status check to be ran under Zenoss.
So while they are creating that check, I decided to google for redis checks...</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/linuxdynasty"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/linuxdynasty"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
      <li><a href="http://bitbucket.org/linuxdynasty"><i class="fa fa-fw fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
    
    <li><a href="http://10.0.0.146:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2016 Allen Sanabria. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="http://10.0.0.146:4000/assets/js/main.min.js"></script>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2333243-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'linuxdynasty';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






  </body>
</html>

